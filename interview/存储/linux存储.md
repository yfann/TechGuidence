# linux存储

## 文件读写

+ 用户空间
    + 应用
+ 内核空间
    + syscall
        + VFS(虚拟文件系统)
            + XFS、Ext4、NFS...
                + 通用设备访问层
                    + 驱动
                        + 磁盘缓存
                            + 磁盘

+ 在Linux进行文件读写时，可以直接透过系统调用、或者透过函数库使用系统调用直达操作系统，然后到达虚拟文件系统（VFS），然后文件系统去分发调用不同的存储结构，比如基于磁盘的XFS、Ext4，还有管理网络链接的NFS，又或是基于内存的/proc、/sys 文件系统。

+ 通过VFS完成对应文件系统的调用，这里磁盘读写可能就会进行XFS的调用，然后进行磁盘的读取，读到的数据会存放在内核缓冲区，然后IO线程将对应的数据从内核缓冲区中读出放到用户态的内存中，然后完成对应的更改之后，再从用户态内存透过虚拟文件系统写入内核缓冲，内核缓冲刷入磁盘。

+ fsync
+ fflush
+ mmap
    + 用户态内存和内核缓冲建立一个映射，避免了内核/用户态切换，可以通过操作用户态内存中的对象，操作内核缓冲，省的显式调用flush。
    
## 读写IO
+ 同步/异步（是不是同一个线程/进程处理IO操作）
+ 阻塞非阻塞（当前线程处理时，无可读/写是否会被挂起）


## 磁盘&文件系统&操作系统
+ 磁盘被划分为几个逻辑单元，每个单元可以被独立管理，每个单元被称为“分区”，然后分区的分配信息存放于分区表中，Linux下，使用fdisk命令进行磁盘分区

+ Superblock
    + 存放整个文件系统的元信息
+ inode blocks
    + inode
        + 文件元数据
+ data blocks
    + 存放数据块
+ 文件目录树
    + dentry
        + 记录了文件名字、inode 指针以及与其他 dentry 的关联关系

+ 分区是磁盘挂载的第一步，区分好分区，并确定文件系统类型之后，再注册到操作系统中，这是磁盘挂载的第二步

+ 在linux中，使用目录树来进行管理，直白的就是以根目录为入口，向下呈现分枝状的一种文件结构。linux必须能够将根文件系统挂载到根目录上，当根目录挂载完成之后，我们可以将其它文件系统挂载于树形结构各种挂载点上。根结构下的任何目录都可以作为挂载点，挂载点实际上就是linux中的磁盘文件系统的入口目录。

+ 磁盘的最小的操作单位是扇区（512），多个扇区就构成了“块”结构

## 文件描述符

+ 当进程打开现有文件或创建新文件时，内核向进程返回一个文件描述符，文件描述符就是内核为了高效管理已被打开的文件所创建的索引，用来指向被打开的文件，所有执行I/O操作的系统调用都会通过文件描述符

+ 文件描述符、文件、进程间的关系：
    + 每个文件描述符会与一个打开的文件相对应；
    + 不同的文件描述符也可能指向同一个文件；
    + 相同的文件可以被不同的进程打开，也可以在同一个进程被多次打开；

+ 我们进行文件操作时，其实就是持有文件描述透过系统调用进行文件读写，一个进程能持有的文件描述符数量通常是1024个，不过这个值可改。
    + 另外，linux文件被并发修改时，会有问题的，出现错数据。