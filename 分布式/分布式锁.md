
# 分布式锁

## 分布式 vs 单机
+ 多进程 vs 多线程

+ 多线程共享内存
    + 可以在内存中标记(锁)

+ 多进程锁需要公共内存
    + redis, Memcache

## 基于数据库的锁
<!-- 基于表主键的分布式锁 -->
+ 表主键唯一，同一时间只有一个进程能插入成功. 相当于获取锁
    + 删除数据相当于释放锁
+ 缺点
    + 数据库是单点，挂掉后业务受影响
    + 锁没有失效时间，删除失败后不会自动释放
    + 只能非阻塞，非重入，非公平
    + 大并发可能会锁表
<!-- 基于表字段做分布式锁 -->
+ MYSQL MVCC
<!-- 基于数据库排它锁 -->
+ 查询语句加`for update`
    + 查询时会给表加排它锁(只有通过索引检索时才会使用行锁)
    + 行锁，表锁不确定

## 基于Redis做分布式锁
+ setnx()
    + SET if Not Exists
    + setnx(key, value)
        + 设置成功返回1
        + key已存在返回0
    + 原子方法

+ expire()
    + 设置key的超时时间

+ 删除key释放锁

## ref
+ [分布式锁看这篇就够了](https://zhuanlan.zhihu.com/p/42056183)
